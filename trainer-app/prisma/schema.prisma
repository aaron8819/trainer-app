// Prisma schema for Personal AI Trainer

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
}

enum TrainingAge {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum PrimaryGoal {
  HYPERTROPHY
  STRENGTH
  FAT_LOSS
  ATHLETICISM
  GENERAL_HEALTH
}

enum SecondaryGoal {
  POSTURE
  CONDITIONING
  INJURY_PREVENTION
  NONE
}

enum SplitType {
  PPL
  UPPER_LOWER
  FULL_BODY
  CUSTOM
}

enum MovementPatternV2 {
  HORIZONTAL_PUSH
  VERTICAL_PUSH
  HORIZONTAL_PULL
  VERTICAL_PULL
  SQUAT
  HINGE
  LUNGE
  CARRY
  ROTATION
  ANTI_ROTATION
  FLEXION
  EXTENSION
  ABDUCTION
  ADDUCTION
  ISOLATION
}

enum SplitTag {
  PUSH
  PULL
  LEGS
  CORE
  MOBILITY
  PREHAB
  CONDITIONING
}

enum JointStress {
  LOW
  MEDIUM
  HIGH
}

enum EquipmentType {
  BARBELL
  DUMBBELL
  MACHINE
  CABLE
  BODYWEIGHT
  KETTLEBELL
  BAND
  SLED
  BENCH
  RACK
  EZ_BAR
  TRAP_BAR
  OTHER
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum WorkoutStatus {
  PLANNED
  IN_PROGRESS
  PARTIAL
  COMPLETED
  SKIPPED
}

enum WorkoutSelectionMode {
  AUTO
  MANUAL
  BONUS
  INTENT
}

enum WorkoutSessionIntent {
  PUSH
  PULL
  LEGS
  UPPER
  LOWER
  FULL_BODY
  BODY_PART
}

enum WorkoutExerciseSection {
  WARMUP
  MAIN
  ACCESSORY
}

enum StimulusBias {
  MECHANICAL
  METABOLIC
  STRETCH
  STABILITY
}

enum SplitDay {
  PUSH
  PULL
  LEGS
  UPPER
  LOWER
  FULL_BODY
}

enum MuscleRole {
  PRIMARY
  SECONDARY
}


enum VariationType {
  TEMPO
  PAUSED
  SINGLE_ARM
  SINGLE_LEG
  GRIP
  ANGLE
  RANGE_OF_MOTION
  OTHER
}

enum TemplateIntent {
  FULL_BODY
  UPPER_LOWER
  PUSH_PULL_LEGS
  BODY_PART
  CUSTOM
}

enum BlockType {
  ACCUMULATION      // High volume, moderate intensity
  INTENSIFICATION   // Moderate volume, high intensity
  REALIZATION       // Low volume, peak intensity (testing)
  DELOAD           // Low volume, low intensity (recovery)
}

enum VolumeTarget {
  LOW              // ~50% of normal
  MODERATE         // ~70-80% of normal
  HIGH             // ~90-100% of normal
  PEAK             // ~100-110% of normal (approaching MRV)
}

enum IntensityBias {
  STRENGTH         // 1-6 reps, heavy loads
  HYPERTROPHY      // 6-12 reps, moderate loads
  ENDURANCE        // 12-20+ reps, lighter loads
}

enum AdaptationType {
  NEURAL_ADAPTATION           // Strength gains via CNS efficiency
  MYOFIBRILLAR_HYPERTROPHY   // Muscle fiber growth
  SARCOPLASMIC_HYPERTROPHY   // Metabolic adaptations
  WORK_CAPACITY              // Conditioning
  RECOVERY                   // Active recovery
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  createdAt DateTime @default(now())

  profile          Profile?
  constraints      Constraints?
  goals            Goals?
  injuries         Injury[]
  workouts         Workout[]
  sessionCheckIns  SessionCheckIn[]
  preferences      UserPreference?
  templates        WorkoutTemplate[]
  macroCycles      MacroCycle[]
  exerciseExposures ExerciseExposure[]
  readinessSignals ReadinessSignal[]
  integrations     UserIntegration[]
}

model UserPreference {
  userId              String   @id
  user                User     @relation(fields: [userId], references: [id])
  favoriteExerciseIds String[] @default([])
  avoidExerciseIds    String[] @default([])
  updatedAt           DateTime @updatedAt
}

model Profile {
  userId      String       @id
  user        User         @relation(fields: [userId], references: [id])
  age         Int?
  sex         String?
  heightIn    Int?
  weightLb    Float?
  trainingAge TrainingAge @default(INTERMEDIATE)
}

model Constraints {
  userId         String    @id
  user           User      @relation(fields: [userId], references: [id])
  daysPerWeek    Int
  splitType      SplitType
}

model Goals {
  userId        String         @id
  user          User           @relation(fields: [userId], references: [id])
  primaryGoal   PrimaryGoal
  secondaryGoal SecondaryGoal
}

model Injury {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  bodyPart    String
  description String?
  severity    Int      // 1-5
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@index([userId, isActive])
}

model Equipment {
  id   String        @id @default(uuid())
  name String        @unique
  type EquipmentType

  exerciseEquipment ExerciseEquipment[]
}

model Muscle {
  id       String @id @default(uuid())
  name     String @unique
  mv       Int    @default(0)
  mev      Int    @default(0)
  mav      Int    @default(0)
  mrv      Int    @default(0)
  sraHours Int    @default(48)

  exerciseMuscles ExerciseMuscle[]
}

model Exercise {
  id                  String          @id @default(uuid())
  name                String          @unique
  movementPatterns    MovementPatternV2[] @default([])
  splitTags           SplitTag[] @default([])
  jointStress         JointStress
  isMainLiftEligible  Boolean         @default(false)
  isCompound          Boolean         @default(false)
  fatigueCost         Int             @default(3)
  stimulusBias        StimulusBias[]  @default([])
  contraindications   Json?
  timePerSetSec       Int             @default(120)
  sfrScore            Int             @default(3)
  lengthPositionScore Int             @default(3)
  difficulty          Difficulty      @default(BEGINNER)
  isUnilateral        Boolean         @default(false)
  repRangeMin         Int             @default(1)
  repRangeMax         Int             @default(20)

  variations            ExerciseVariation[]
  aliases               ExerciseAlias[]
  exerciseMuscles       ExerciseMuscle[]
  exerciseEquipment     ExerciseEquipment[]
  workoutExercises      WorkoutExercise[]
  substitutionsFrom     SubstitutionRule[] @relation("SubstitutionFrom")
  substitutionsTo       SubstitutionRule[] @relation("SubstitutionTo")
  templateExercises     WorkoutTemplateExercise[]
}

model ExerciseVariation {
  id          String   @id @default(uuid())
  exerciseId  String
  exercise    Exercise @relation(fields: [exerciseId], references: [id])
  name        String
  description String?
  variationType VariationType?
  metadata    Json?
}

model ExerciseAlias {
  id         String   @id @default(uuid())
  exerciseId String
  exercise   Exercise @relation(fields: [exerciseId], references: [id])
  alias      String   @unique
}

model ExerciseMuscle {
  exerciseId String
  muscleId   String
  role       MuscleRole

  exercise Exercise @relation(fields: [exerciseId], references: [id])
  muscle   Muscle   @relation(fields: [muscleId], references: [id])

  @@id([exerciseId, muscleId])
  @@index([muscleId])
}

model ExerciseEquipment {
  exerciseId  String
  equipmentId String

  exercise  Exercise  @relation(fields: [exerciseId], references: [id])
  equipment Equipment @relation(fields: [equipmentId], references: [id])

  @@id([exerciseId, equipmentId])
}

model SubstitutionRule {
  id            String   @id @default(uuid())
  fromExerciseId String
  toExerciseId   String
  reason        String?
  priority      Int      @default(50)
  constraints   Json?
  preserves     Json?

  fromExercise Exercise @relation("SubstitutionFrom", fields: [fromExerciseId], references: [id])
  toExercise   Exercise @relation("SubstitutionTo", fields: [toExerciseId], references: [id])

  @@index([fromExerciseId])
  @@index([toExerciseId])
}

model Workout {
  id              String        @id @default(uuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  templateId      String?
  template        WorkoutTemplate? @relation(fields: [templateId], references: [id])
  scheduledDate   DateTime
  completedAt     DateTime?
  status          WorkoutStatus @default(PLANNED)
  estimatedMinutes Int?
  notes           String?
  selectionMode   WorkoutSelectionMode @default(AUTO)
  sessionIntent   WorkoutSessionIntent?
  selectionMetadata Json?
  revision        Int           @default(1)
  forcedSplit     SplitDay?
  advancesSplit   Boolean @default(true)

  // Periodization context (nullable for backward compat)
  trainingBlockId    String?
  trainingBlock      TrainingBlock? @relation(fields: [trainingBlockId], references: [id])
  weekInBlock        Int?           // 1, 2, 3 within block

  // Autoregulation tracking (Phase 3)
  wasAutoregulated Boolean @default(false)
  autoregulationLog Json?  // { modifications: [...], fatigueScore: 0.45, rationale: "..." }

  exercises WorkoutExercise[]
  sessionCheckIns SessionCheckIn[]
  filteredExercises FilteredExercise[]

  @@index([userId, scheduledDate])
  @@index([trainingBlockId])
}

model WorkoutExercise {
  id              String              @id @default(uuid())
  workoutId       String
  workout         Workout             @relation(fields: [workoutId], references: [id])
  exerciseId      String
  exercise        Exercise            @relation(fields: [exerciseId], references: [id])
  orderIndex      Int
  section         WorkoutExerciseSection?
  isMainLift      Boolean
  movementPatterns MovementPatternV2[] @default([])
  notes           String?

  sets WorkoutSet[]

  @@unique([workoutId, orderIndex])
}

model WorkoutSet {
  id                String   @id @default(uuid())
  workoutExerciseId String
  workoutExercise   WorkoutExercise @relation(fields: [workoutExerciseId], references: [id])
  setIndex          Int
  targetReps        Int
  targetRepMin      Int?
  targetRepMax      Int?
  targetRpe         Float?
  targetLoad        Float?
  restSeconds       Int?

  logs SetLog[]
}

model FilteredExercise {
  id                  String  @id @default(uuid())
  workoutId           String
  workout             Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  exerciseId          String?
  exerciseName        String
  reason              String
  userFriendlyMessage String

  @@index([workoutId])
}

model SetLog {
  id            String   @id @default(uuid())
  workoutSetId  String   @unique
  workoutSet    WorkoutSet @relation(fields: [workoutSetId], references: [id])
  actualReps    Int?
  actualRpe     Float?
  actualLoad    Float?
  completedAt   DateTime @default(now())
  notes         String?
  wasSkipped    Boolean  @default(false)
}


model SessionCheckIn {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  workoutId  String?
  workout    Workout? @relation(fields: [workoutId], references: [id])
  date       DateTime
  readiness  Int      // 1-5
  painFlags  Json?
  notes      String?
  createdAt  DateTime @default(now())

  @@index([userId, date])
}

// Phase 3: Autoregulation & Readiness Integration
model ReadinessSignal {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  timestamp  DateTime @default(now())

  // Whoop data (stubbed, nullable until Phase 3.5)
  whoopRecovery     Float?  // 0-100
  whoopStrain       Float?  // 0-21
  whoopHrv          Float?  // ms (RMSSD)
  whoopSleepQuality Float?  // 0-100
  whoopSleepHours   Float?  // hours

  // Subjective (always present)
  subjectiveReadiness  Int  // 1-5
  subjectiveMotivation Int  // 1-5
  subjectiveSoreness   Json // Map<MuscleGroup, 1-3>
  subjectiveStress     Int? // 1-5 (optional)

  // Performance (computed from history)
  performanceRpeDeviation  Float  // Avg(actual - expected RPE) last 3 sessions
  performanceStalls        Int    // Count of stalled exercises
  performanceCompliance    Float  // % sets completed (0-1)

  // Computed fatigue score (stored for analytics)
  fatigueScoreOverall      Float  // 0-1 (0=exhausted, 1=fresh)
  fatigueScoreBreakdown    Json   // { whoop: 0.35, subjective: 0.2, performance: 0.1 }

  @@index([userId, timestamp(sort: Desc)])
}

model UserIntegration {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  provider     String   // "whoop", "oura", "garmin" (future)
  accessToken  String?  @db.Text
  refreshToken String?  @db.Text
  expiresAt    DateTime?

  isActive     Boolean  @default(true)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, provider])
  @@index([userId, isActive])
}


model WorkoutTemplate {
  id             String   @id @default(uuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  name           String
  targetMuscles  String[] @default([])
  isStrict       Boolean  @default(false)
  intent         TemplateIntent @default(CUSTOM)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  exercises WorkoutTemplateExercise[]
  workouts  Workout[]
}

model WorkoutTemplateExercise {
  id         String          @id @default(uuid())
  templateId String
  template   WorkoutTemplate @relation(fields: [templateId], references: [id])
  exerciseId String
  exercise   Exercise        @relation(fields: [exerciseId], references: [id])
  orderIndex Int
  supersetGroup Int?

  @@unique([templateId, orderIndex])
}

model MacroCycle {
  id              String      @id @default(uuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  startDate       DateTime
  endDate         DateTime
  durationWeeks   Int

  trainingAge     TrainingAge
  primaryGoal     PrimaryGoal

  mesocycles      Mesocycle[]

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([userId, startDate])
}

model Mesocycle {
  id              String        @id @default(uuid())
  macroCycleId    String
  macroCycle      MacroCycle    @relation(fields: [macroCycleId], references: [id], onDelete: Cascade)

  mesoNumber         Int           // 1, 2, 3... within macro
  startWeek          Int           // Week offset from macro start (0-indexed)
  durationWeeks      Int

  focus              String        // "Upper Body Hypertrophy", "Lower Strength", etc.
  volumeTarget       VolumeTarget
  intensityBias      IntensityBias

  // ADR-080: Session-count-based week tracking
  completedSessions  Int           @default(0) // incremented on each logged workout
  isActive           Boolean       @default(false) // true for the current meso

  blocks             TrainingBlock[]

  @@unique([macroCycleId, mesoNumber])
  @@index([macroCycleId])
  @@index([macroCycleId, isActive])
}

model TrainingBlock {
  id              String          @id @default(uuid())
  mesocycleId     String
  mesocycle       Mesocycle       @relation(fields: [mesocycleId], references: [id], onDelete: Cascade)

  blockNumber     Int             // 1, 2, 3... within meso
  blockType       BlockType

  startWeek       Int             // Week offset from macro start
  durationWeeks   Int

  volumeTarget    VolumeTarget
  intensityBias   IntensityBias
  adaptationType  AdaptationType

  workouts        Workout[]

  @@unique([mesocycleId, blockNumber])
  @@index([mesocycleId])
}

model ExerciseExposure {
  id              String      @id @default(uuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  exerciseName    String
  lastUsedAt      DateTime
  timesUsedL4W    Int         @default(0)  // Last 4 weeks
  timesUsedL8W    Int         @default(0)  // Last 8 weeks
  timesUsedL12W   Int         @default(0)  // Last 12 weeks

  avgSetsPerWeek  Float       @default(0)
  avgVolumePerWeek Float      @default(0)

  updatedAt       DateTime    @updatedAt

  @@unique([userId, exerciseName])
  @@index([userId, lastUsedAt])
}

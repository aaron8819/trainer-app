// Prisma schema for Personal AI Trainer

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
}

enum TrainingAge {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum PrimaryGoal {
  HYPERTROPHY
  STRENGTH
  FAT_LOSS
  ATHLETICISM
  GENERAL_HEALTH
}

enum SecondaryGoal {
  POSTURE
  CONDITIONING
  INJURY_PREVENTION
  NONE
}

enum SplitType {
  PPL
  UPPER_LOWER
  FULL_BODY
  CUSTOM
}

enum MovementPatternV2 {
  HORIZONTAL_PUSH
  VERTICAL_PUSH
  HORIZONTAL_PULL
  VERTICAL_PULL
  SQUAT
  HINGE
  LUNGE
  CARRY
  ROTATION
  ANTI_ROTATION
  FLEXION
  EXTENSION
  ABDUCTION
  ADDUCTION
  ISOLATION
}

enum SplitTag {
  PUSH
  PULL
  LEGS
  CORE
  MOBILITY
  PREHAB
  CONDITIONING
}

enum JointStress {
  LOW
  MEDIUM
  HIGH
}

enum EquipmentType {
  BARBELL
  DUMBBELL
  MACHINE
  CABLE
  BODYWEIGHT
  KETTLEBELL
  BAND
  CARDIO
  SLED
  BENCH
  RACK
  EZ_BAR
  TRAP_BAR
  OTHER
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum WorkoutStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum WorkoutSelectionMode {
  AUTO
  MANUAL
  BONUS
}

enum StimulusBias {
  MECHANICAL
  METABOLIC
  STRETCH
  STABILITY
}

enum SplitDay {
  PUSH
  PULL
  LEGS
  UPPER
  LOWER
  FULL_BODY
}

enum MuscleRole {
  PRIMARY
  SECONDARY
}

enum BaselineCategory {
  MAIN_LIFT
  BARBELL_ACCESSORY
  DUMBBELL
  MACHINE_CABLE
  BENCH_VARIATION
  OTHER
}

enum VariationType {
  TEMPO
  PAUSED
  SINGLE_ARM
  SINGLE_LEG
  GRIP
  ANGLE
  RANGE_OF_MOTION
  OTHER
}

enum TemplateIntent {
  FULL_BODY
  UPPER_LOWER
  PUSH_PULL_LEGS
  BODY_PART
  CUSTOM
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  createdAt DateTime @default(now())

  profile        Profile?
  constraints    Constraints?
  goals          Goals?
  injuries       Injury[]
  programs       Program[]
  workouts       Workout[]
  sessionCheckIns SessionCheckIn[]
  baselines      Baseline[]
  preferences    UserPreference?
  templates      WorkoutTemplate[]
}

model UserPreference {
  userId               String   @id
  user                 User     @relation(fields: [userId], references: [id])
  favoriteExercises    String[] @default([])
  avoidExercises       String[] @default([])
  favoriteExerciseIds  String[] @default([])
  avoidExerciseIds     String[] @default([])
  rpeTargets           Json?
  progressionStyle     String?
  optionalConditioning Boolean  @default(true)
  benchFrequency       Int?
  squatFrequency       Int?
  deadliftFrequency    Int?
  updatedAt            DateTime @updatedAt
}

model Profile {
  userId      String       @id
  user        User         @relation(fields: [userId], references: [id])
  age         Int?
  sex         String?
  heightIn    Int?
  weightLb    Float?
  trainingAge TrainingAge @default(INTERMEDIATE)
}

model Constraints {
  userId         String    @id
  user           User      @relation(fields: [userId], references: [id])
  daysPerWeek    Int
  sessionMinutes Int
  splitType      SplitType
  equipmentNotes String?
  availableEquipment EquipmentType[] @default([])
}

model Goals {
  userId        String         @id
  user          User           @relation(fields: [userId], references: [id])
  primaryGoal   PrimaryGoal
  secondaryGoal SecondaryGoal
  proteinTarget Int?
}

model Injury {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  bodyPart    String
  description String?
  severity    Int      // 1-5
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@index([userId, isActive])
}

model Equipment {
  id   String        @id @default(uuid())
  name String        @unique
  type EquipmentType

  exerciseEquipment ExerciseEquipment[]
}

model Muscle {
  id       String @id @default(uuid())
  name     String @unique
  mv       Int    @default(0)
  mev      Int    @default(0)
  mav      Int    @default(0)
  mrv      Int    @default(0)
  sraHours Int    @default(48)

  exerciseMuscles ExerciseMuscle[]
}

model Exercise {
  id                  String          @id @default(uuid())
  name                String          @unique
  movementPatterns    MovementPatternV2[] @default([])
  splitTags           SplitTag[] @default([])
  jointStress         JointStress
  isMainLiftEligible  Boolean         @default(false)
  isCompound          Boolean         @default(false)
  fatigueCost         Int             @default(3)
  stimulusBias        StimulusBias[]  @default([])
  contraindications   Json?
  timePerSetSec       Int             @default(120)
  sfrScore            Int             @default(3)
  lengthPositionScore Int             @default(3)
  difficulty          Difficulty      @default(BEGINNER)
  isUnilateral        Boolean         @default(false)
  repRangeMin         Int             @default(1)
  repRangeMax         Int             @default(20)

  variations            ExerciseVariation[]
  aliases               ExerciseAlias[]
  exerciseMuscles       ExerciseMuscle[]
  exerciseEquipment     ExerciseEquipment[]
  workoutExercises      WorkoutExercise[]
  substitutionsFrom     SubstitutionRule[] @relation("SubstitutionFrom")
  substitutionsTo       SubstitutionRule[] @relation("SubstitutionTo")
  baselines             Baseline[]
  templateExercises     WorkoutTemplateExercise[]
}

model ExerciseVariation {
  id          String   @id @default(uuid())
  exerciseId  String
  exercise    Exercise @relation(fields: [exerciseId], references: [id])
  name        String
  description String?
  variationType VariationType?
  metadata    Json?
}

model ExerciseAlias {
  id         String   @id @default(uuid())
  exerciseId String
  exercise   Exercise @relation(fields: [exerciseId], references: [id])
  alias      String   @unique
}

model ExerciseMuscle {
  exerciseId String
  muscleId   String
  role       MuscleRole

  exercise Exercise @relation(fields: [exerciseId], references: [id])
  muscle   Muscle   @relation(fields: [muscleId], references: [id])

  @@id([exerciseId, muscleId])
}

model ExerciseEquipment {
  exerciseId  String
  equipmentId String

  exercise  Exercise  @relation(fields: [exerciseId], references: [id])
  equipment Equipment @relation(fields: [equipmentId], references: [id])

  @@id([exerciseId, equipmentId])
}

model SubstitutionRule {
  id            String   @id @default(uuid())
  fromExerciseId String
  toExerciseId   String
  reason        String?
  priority      Int      @default(50)
  constraints   Json?
  preserves     Json?

  fromExercise Exercise @relation("SubstitutionFrom", fields: [fromExerciseId], references: [id])
  toExercise   Exercise @relation("SubstitutionTo", fields: [toExerciseId], references: [id])
}

model Program {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  name      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  blocks ProgramBlock[]
}

model ProgramBlock {
  id         String   @id @default(uuid())
  programId  String
  program    Program  @relation(fields: [programId], references: [id])
  blockIndex Int
  weeks      Int
  deloadWeek Int?

  workouts Workout[]
}

model Workout {
  id              String        @id @default(uuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  programBlockId  String?
  programBlock    ProgramBlock? @relation(fields: [programBlockId], references: [id])
  templateId      String?
  template        WorkoutTemplate? @relation(fields: [templateId], references: [id])
  scheduledDate   DateTime
  completedAt     DateTime?
  status          WorkoutStatus @default(PLANNED)
  estimatedMinutes Int?
  notes           String?
  selectionMode   WorkoutSelectionMode @default(AUTO)
  forcedSplit     SplitDay?
  advancesSplit   Boolean @default(true)

  exercises WorkoutExercise[]
  sessionCheckIns SessionCheckIn[]

  @@index([userId, scheduledDate])
}

model WorkoutExercise {
  id              String              @id @default(uuid())
  workoutId       String
  workout         Workout             @relation(fields: [workoutId], references: [id])
  exerciseId      String
  exercise        Exercise            @relation(fields: [exerciseId], references: [id])
  orderIndex      Int
  isMainLift      Boolean
  movementPatterns MovementPatternV2[] @default([])
  notes           String?

  sets WorkoutSet[]
}

model WorkoutSet {
  id                String   @id @default(uuid())
  workoutExerciseId String
  workoutExercise   WorkoutExercise @relation(fields: [workoutExerciseId], references: [id])
  setIndex          Int
  targetReps        Int
  targetRepMin      Int?
  targetRepMax      Int?
  targetRpe         Float?
  targetLoad        Float?
  restSeconds       Int?

  logs SetLog[]
}

model SetLog {
  id            String   @id @default(uuid())
  workoutSetId  String   @unique
  workoutSet    WorkoutSet @relation(fields: [workoutSetId], references: [id])
  actualReps    Int?
  actualRpe     Float?
  actualLoad    Float?
  completedAt   DateTime @default(now())
  notes         String?
  wasSkipped    Boolean  @default(false)
}


model SessionCheckIn {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  workoutId  String?
  workout    Workout? @relation(fields: [workoutId], references: [id])
  date       DateTime
  readiness  Int      // 1-5
  painFlags  Json?
  notes      String?
  createdAt  DateTime @default(now())

  @@index([userId, date])
}


model Baseline {
  id               String           @id @default(uuid())
  userId           String
  user             User             @relation(fields: [userId], references: [id])
  exerciseId       String
  exercise         Exercise         @relation(fields: [exerciseId], references: [id])
  exerciseName     String           // denormalized display field
  context          String           @default("default")
  category         BaselineCategory
  unit             String           @default("lbs")
  workingWeightMin Float?
  workingWeightMax Float?
  workingRepsMin   Int?
  workingRepsMax   Int?
  topSetWeight     Float?
  topSetReps       Int?
  projected1RMMin  Float?
  projected1RMMax  Float?
  notes            String?
  createdAt        DateTime         @default(now())

  @@unique([userId, exerciseId, context])
  @@index([exerciseId])
}

model WorkoutTemplate {
  id             String   @id @default(uuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  name           String
  targetMuscles  String[] @default([])
  isStrict       Boolean  @default(false)
  intent         TemplateIntent @default(CUSTOM)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  exercises WorkoutTemplateExercise[]
  workouts  Workout[]
}

model WorkoutTemplateExercise {
  id         String          @id @default(uuid())
  templateId String
  template   WorkoutTemplate @relation(fields: [templateId], references: [id])
  exerciseId String
  exercise   Exercise        @relation(fields: [exerciseId], references: [id])
  orderIndex Int
  supersetGroup Int?

  @@unique([templateId, orderIndex])
}
